/*! 
 * stVideo 
 * HTML5 video canvas player. Prevents video fullscreen on iPhone/iPad.
 * 
 * Licensed under the MIT license: 
 * http://www.opensource.org/licenses/mit-license.php 
 * 
 * Any and all use of this script must be accompanied by this copyright/license notice in its present form. 
 * 
 * Version: 0.9.0
 * Author: Tomasz Stabla <t.stabla@hotmail.com> (http://stabla.com)
 * Site: https://github.com/tstabla/stVideo/
 */

!function(a,b){"function"==typeof define&&define.amd?define([],function(){return b(a)}):"object"==typeof module&&module.exports?module.exports=b(a):a.stVideo=b(a)}("undefined"!=typeof global?global:this.window||this.global,function(a){"use strict";!function(a){for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;++d)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(c,d){var e=(new Date).getTime(),f=Math.max(0,16-(e-b)),g=a.setTimeout(function(){c(e+f)},f);return b=e+f,g}),a.cancelAnimationFrame||(a.cancelAnimationFrame=function(a){clearTimeout(a)})}(a);var b=function(a,b){return this.iOS=/iPhone|iPad|iPod/i.test(navigator.userAgent),this.isMobile=navigator.userAgent.match(/Android|AvantGo|BlackBerry|DoCoMo|Fennec|iPod|iPhone|iPad|J2ME|MIDP|NetFront|Nokia|Opera Mini|Opera Mobi|PalmOS|PalmSource|portalmmm|Plucker|ReqwirelessWeb|SonyEricsson|Symbian|UP\\.Browser|webOS|Windows CE|Windows Phone OS|Xiino/i),this.useTouch=!!("ontouchstart"in window)||!!("ontouchstart"in document.documentElement)||!!window.ontouchstart||!!window.onmsgesturechange||window.DocumentTouch&&window.document instanceof window.DocumentTouch,this.element=document.querySelector(a),this.defaults={force:"",framesPerSecond:30,volume:1},this.settings=this.getSettings(b),(this.settings.mp4||this.settings.webm||this.settings.ogg)&&this.settings.width&&this.settings.height?("video"===this.settings.force?this.useCanvas=!1:"canvas"===this.settings.force&&(this.useCanvas=!0),this.classNames={init:"stvideo-box",error:"stvideo-box--error",isPlaying:"stvideo-box--is-playing",isPaused:"stvideo-box--is-paused",isEnded:"stvideo-box--is-ended",isMuted:"stvideo-box--is-muted",isHandle:"stvideo-box--is-handle",hasAudio:"stvideo-box--has-audio",player:"stvideo-box__player",poster:"stvideo-box__poster",play:"stvideo-box__play",playPause:"stvideo-box__play-pause",controls:"stvideo-box__controls",timeline:"stvideo-box__timeline",progress:"stvideo-box__progress",handle:"stvideo-box__handle",duration:"stvideo-box__duration",volume:"stvideo-box__volume"},this.timelineSettings={wrapperWidth:0,isMouseDown:!1,isHandleMoving:!1,startX:0,touchObj:null,posLeft:0,lastPosLeft:0,lastDistance:0,lastDirection:""},this.eventsUserCollection=[],this.eventsVideoCollection=[],this.eventsControlsCollection=[],void this.initPlayer()):(this.isError=!0,void this.error.checkSettings())};return b.prototype.getSettings=function(a){var b,c,d;a||(b=this.element.getAttribute("data-stvideo"),b=b.replace(/\'/g,'"'),a=JSON.parse(b)),c=this.defaults;for(d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);return c},b.prototype.isContained=function(a,b){for(var c=b||window.event,d=/(click)|(mousedown)|(mouseup)/i.test(c.type)?c.target:c.relatedTarget||("mouseover"==c.type?c.fromElement:c.toElement);d&&d!=a;)try{d=d.parentNode}catch(b){d=a}return d==a},b.prototype.initPlayer=function(){var a,b,c,d,e,f,g,h=this;return this.element.classList.add(this.classNames.init),c=document.createElement("video"),c.setAttribute("width",this.settings.width),c.setAttribute("height",this.settings.height),a=this.supportedVideoFormat(c),!a||this.useCanvas&&!this.settings.mp4||!this.settings[a.ext]?void this.error.badVideoFormat.call(this):(d=document.createElement("source"),d.setAttribute("src",this.settings[a.ext]),d.setAttribute("type",a.type),c.appendChild(d),b=document.createElement("div"),b.classList.add(this.classNames.player),this.useCanvas?(e=document.createElement("canvas"),e.setAttribute("width",this.settings.width),e.setAttribute("height",this.settings.height),f=e.getContext("2d"),f.fillStyle="#ffffff",f.fillRect(0,0,this.settings.width,this.settings.height),f.drawImage(c,0,0,this.settings.width,this.settings.height),this.canvasContext=f,b.appendChild(e)):b.appendChild(c),this.element.appendChild(b),c.load(),this.video=c,this.playerControls(),this.addVideoListeners(),this.addControlsListeners(),void(this.isMobile?window.addEventListener("orientationchange",function(){this.resizeTo&&clearTimeout(this.resizeTo),this.resizeTo=setTimeout(function(){for(g=0;g<h.resizeCacheArr.length;g++)h.resizeCacheArr[g]()},200)},!1):window.addEventListener("resize",function(){this.resizeTo&&clearTimeout(this.resizeTo),this.resizeTo=setTimeout(function(){for(g=0;g<h.resizeCacheArr.length;g++)h.resizeCacheArr[g]()},200)})))},b.prototype.resizeHandler=function(a){this.resizeCacheArr=this.resizeCacheArr||[],a(),this.resizeCacheArr.push(a)},b.prototype.supportedVideoFormat=function(a){var b={};return"probably"===a.canPlayType("video/webm")||"maybe"===a.canPlayType("video/webm")?(b.ext="webm",b.type='video/webm; codecs="vp8, vorbis"'):"probably"===a.canPlayType("video/mp4")||"maybe"===a.canPlayType("video/mp4")?(b.ext="mp4",b.type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'):"probably"!==a.canPlayType("video/ogg")&&"maybe"!==a.canPlayType("video/ogg")||(b.ext="ogg",b.type='video/ogg; codecs="theora, vorbis"'),b},b.prototype.videoAudio=function(a){var b,c,d=this;return a.mozHasAudio||Boolean(a.webkitAudioDecodedByteCount)||Boolean(a.audioTracks&&a.audioTracks.length)?(this.hasAudio=!0,this.element.classList.add(this.classNames.hasAudio),c=document.createElement("div"),c.classList.add(this.classNames.volume),this.elControls.appendChild(c),this.elVolume=c,this.elVolume.addEventListener("click",b=function(){d.isMuted?(d.video.volume=d.settings.volume,d.audio&&(d.audio.volume=d.settings.volume,d.audio.currentTime=d.video.currentTime,d.isPlaying&&d.audio.play(),d.iOS&&d.changeState("muted",!1))):(d.video.volume=.01,d.audio&&(d.audio.volume=.01,d.audio.pause(),d.iOS&&d.changeState("muted",!0)))}),this.eventsControlsCollection.push(b)):this.hasAudio=!1,this.hasAudio},b.prototype.playerControls=function(){var a,b,c,d,e,f,g,h,i=this;this.settings.poster&&(a=document.createElement("div"),a.classList.add(this.classNames.poster),a.style.backgroundImage="url("+this.settings.poster+")",this.element.appendChild(a)),g=document.createElement("div"),g.classList.add(this.classNames.play),b=document.createElement("div"),b.classList.add(this.classNames.controls),f=document.createElement("div"),f.classList.add(this.classNames.playPause),c=document.createElement("div"),c.classList.add(this.classNames.timeline),d=document.createElement("div"),d.classList.add(this.classNames.progress),e=document.createElement("div"),e.classList.add(this.classNames.handle),h=document.createElement("div"),h.classList.add(this.classNames.duration),c.appendChild(d),c.appendChild(e),b.appendChild(c),b.appendChild(f),b.appendChild(h),this.element.appendChild(b),this.element.appendChild(g),this.elControls=b,this.elPlay=g,this.elPlayPause=f,this.elTimeline=c,this.elProgress=d,this.elHandle=e,this.elDuration=h,setTimeout(function(){i.resizeHandler(function(){i.timelineSettings.wrapperWidth=i.elTimeline.offsetWidth})},100)},b.prototype.addVideoListeners=function(){var a,b=this;this.video.addEventListener("loadedmetadata",a=function(){var a=b.videoAudio(this);b.useCanvas&&a&&b.canvasAudio()}),b.eventsVideoCollection.push(a),this.video.addEventListener("canplaythrough",a=function(){b.useCanvas&&b.canvasDrawFrame(),b.progressUpdate()}),b.eventsVideoCollection.push(a),b.useCanvas||(this.video.addEventListener("play",a=function(){b.changeState("play",!0),b.changeState("end",!1)}),b.eventsVideoCollection.push(a),this.video.addEventListener("pause",a=function(){b.changeState("pause",!0),b.changeState("play",!1)}),b.eventsVideoCollection.push(a),this.video.addEventListener("ended",a=function(){b.changeState("end",!0),b.changeState("play",!1)}),b.eventsVideoCollection.push(a)),this.video.addEventListener("timeupdate",a=function(){b.useCanvas&&b.canvasDrawFrame(),b.progressUpdate()}),b.eventsVideoCollection.push(a),this.video.addEventListener("volumechange",a=function(){this.volume>.01?b.changeState("muted",!1):b.changeState("muted",!0)}),b.eventsVideoCollection.push(a),this.video.addEventListener("error",a=function(a){b.isError=!0,b.error.custom(a)}),b.eventsVideoCollection.push(a)},b.prototype.addControlsListeners=function(a){var b,c=this;this.elPlay.addEventListener("click",b=function(){c.isPlaying?c.pause():c.play()}),c.eventsControlsCollection.push(b),this.elPlayPause.addEventListener("click",b=function(){c.isPlaying?c.pause():c.play()}),c.eventsControlsCollection.push(b),this.useTouch?(this.elHandle.addEventListener("touchstart",b=function(a){a.stopPropagation(),c.timelineSettings.isHandleMoving=!0,c.timelineSettings.touchObj=a.changedTouches[0],c.timelineSettings.posLeft=c.timelineSettings.lastPosLeft,c.timelineSettings.startX=parseInt(c.timelineSettings.touchObj.clientX),c.changeState("handle",!0)},!1),c.eventsControlsCollection.push(b),this.elHandle.addEventListener("touchmove",b=function(a){if(c.timelineSettings.isHandleMoving){a.stopPropagation(),c.timelineSettings.touchObj=a.changedTouches[0];var b=parseInt(c.timelineSettings.touchObj.clientX)-c.timelineSettings.startX;c.moveHandle(b)}},!1),c.eventsControlsCollection.push(b),this.elHandle.addEventListener("touchend",b=function(a){a.preventDefault(),c.timelineSettings.posLeft=c.timelineSettings.lastPosLeft,c.moveHandle(0,!0),c.changeState("handle",!1),c.timelineSettings.isHandleMoving=!1},!1),c.eventsControlsCollection.push(b)):(document.body.addEventListener("mousedown",b=function(a){if(a.preventDefault(),c.timelineSettings.isHandleMoving=!0,c.isContained(c.elHandle,a))c.timelineSettings.touchObj=a,c.timelineSettings.posLeft=c.timelineSettings.lastPosLeft,c.timelineSettings.startX=parseInt(a.clientX),c.timelineSettings.isMouseDown=!0,c.changeState("handle",!0);else if(c.isContained(c.elTimeline,a)){c.timelineSettings.touchObj=a,c.timelineSettings.posLeft=0,c.timelineSettings.startX=parseInt(a.layerX);var b=c.timelineSettings.startX;c.moveHandle(b,!0),c.timelineSettings.isHandleMoving=!1}else c.timelineSettings.isHandleMoving=!1},!1),c.eventsControlsCollection.push(b),document.body.addEventListener("mousemove",b=function(a){if(a.preventDefault(),c.timelineSettings.isMouseDown&&c.timelineSettings.isHandleMoving){c.timelineSettings.touchObj=a;var b=parseInt(c.timelineSettings.touchObj.clientX)-c.timelineSettings.startX;c.moveHandle(b)}},!1),c.eventsControlsCollection.push(b),document.body.addEventListener("mouseup",b=function(a){a.preventDefault(),c.timelineSettings.isMouseDown&&(c.timelineSettings.touchObj=a,c.timelineSettings.posLeft=c.timelineSettings.lastPosLeft,c.timelineSettings.startX=parseInt(c.timelineSettings.touchObj.clientX),c.timelineSettings.isMouseDown=!1,c.moveHandle(0,!0),c.changeState("handle",!1),c.timelineSettings.isHandleMoving=!1)},!1),c.eventsControlsCollection.push(b))},b.prototype.canvasAudio=function(){this.audio=document.createElement("audio"),this.audio.innerHTML=this.video.innerHTML,this.audio.load()},b.prototype.canvasControl=function(b){"play"===b||"play"===b&&this.isEnded?(this.isEnded&&(this.changeState("end",!1),this.video.currentTime=0,this.audio&&(this.audio.currentTime=0),this.lastTime=Date.now()),this.audio&&this.isMuted!==!0&&this.audio.play(),this.changeState("play",!0),this.animationFrame=a.requestAnimationFrame(this.canvasFrameUpdate.bind(this))):"pause"!==b&&"ended"!==b||("ended"===b?this.changeState("end",!0):this.changeState("pause",!0),this.audio&&this.audio.pause(),this.changeState("play",!1),a.cancelAnimationFrame(this.animationFrame))},b.prototype.canvasFrameUpdate=function(){var b=Date.now(),c=(b-(this.lastTime||b))/1e3;(!c||c>=1/this.settings.framesPerSecond)&&(this.video.currentTime=this.video.currentTime+c,this.lastTime=b),this.video.currentTime>=this.video.duration?this.canvasControl("ended"):this.animationFrame=a.requestAnimationFrame(this.canvasFrameUpdate.bind(this))},b.prototype.canvasDrawFrame=function(){this.canvasContext.drawImage(this.video,0,0,this.settings.width,this.settings.height)},b.prototype.progressUpdate=function(a){var b=this.video.currentTime,c=this.video.duration,d=this.timelineSettings;a&&(b=this.video.currentTime=a/d.wrapperWidth*c);var e=(b/c*d.wrapperWidth).toFixed(2);e<0?e=0:e>d.wrapperWidth&&(e=d.wrapperWidth),this.elProgress.style.width=+e+"px",d.isHandleMoving||(this.elHandle.style.left=+e+"px"),this.elDuration.innerText=this.formatTime(b)+" / "+this.formatTime(c)},b.prototype.formatTime=function(a){var b,c;return b=Math.floor(a/60),b=b>=10?b:"0"+b,c=Math.floor(a%60),c=c>=10?c:"0"+c,b+":"+c},b.prototype.moveHandle=function(a,b){var c=this.timelineSettings;if(c.isHandleMoving){var d=(b?c.lastDistance:a)>0?"right":"left",e=c.posLeft+a;e<0?e=0:e>c.wrapperWidth&&(e=c.wrapperWidth),this.elHandle.style.left=e+"px",c.lastPosLeft=e,c.lastDistance=a,c.lastDirection=d,b&&this.progressUpdate(e)}},b.prototype.error={badVideoFormat:function(){this.useCanvas?console.error("Apple devices support only .mp4 format"):console.error("Best use .webm and .mp4 video formats"),this.element.classList.add(this.classNames.error)},checkSettings:function(){console.error("Check all required settings"),this.element.classList.add(this.classNames.error)},custom:function(a){console.error(a),this.element.classList.add(this.classNames.error)}},b.prototype.on=function(a,b){if(!this.isError){var c,d=this;this.video.addEventListener(a,c=function(){b.call(this)}),c.fnName=a,d.eventsUserCollection.push(c)}},b.prototype.eventCallback=function(a){if(this.useCanvas)for(var b in this.eventsUserCollection)this.eventsUserCollection[b].fnName===a&&this.eventsUserCollection[b]()},b.prototype.play=function(){this.isError||(this.lastTime=Date.now(),this.useCanvas?this.canvasControl("play"):this.video.play())},b.prototype.pause=function(){this.isError||this.isPlaying&&(this.useCanvas?this.canvasControl("pause"):this.video.pause())},b.prototype.changeState=function(a,b){var c=this.element.classList;"play"===a&&(this.isPlaying=b,b?(c.add(this.classNames.isPlaying),this.eventCallback("play")):c.remove(this.classNames.isPlaying)),"pause"===a&&(this.isPaused=b,b?(c.add(this.classNames.isPaused),this.eventCallback("pause")):c.remove(this.classNames.isPaused)),"end"===a&&(this.isEnded=b,b?(c.add(this.classNames.isEnded),this.eventCallback("end")):c.remove(this.classNames.isEnded)),"muted"===a&&(this.isMuted=b,b?(c.add(this.classNames.isMuted),this.eventCallback("muted")):c.remove(this.classNames.isMuted)),"handle"===a&&(this.isMuted=b,b?c.add(this.classNames.isHandle):c.remove(this.classNames.isHandle))},b.prototype.destroy=function(){},b});
//# sourceMappingURL=stvideo.min.js.map